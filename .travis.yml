language: python
python: 3.7
jobs:
  include:
    - env: TOXENV=build
    - env: TOXENV=pre-commit
    - stage: Create GitHub release
      env: TOXENV=build
      before_deploy:
        - export AUTHOR_EMAIL="$(git log -1 $TRAVIS_COMMIT --pretty="%cE")"
        - export AUTHOR_NAME="$(git log -1 $TRAVIS_COMMIT --pretty="%aN")"
        - export GIT_TAG="$(cat version.txt | tr -d ' \t\n\r')"
        - git config --local user.name $AUTHOR_NAME
        - git config --local user.email $AUTHOR_EMAIL
        - git tag $GIT_TAG
      deploy:
        provider: releases
        skip_cleanup: true
        draft: true
        api_key:
          secure: "nvzPqxwOGbRRBtPRKK65oI0jue6nrU9qvcBOaxBL6Ch4IToocXvA3WAVLxusDV7X8UcMfwLF8FcjvezpU5OVR50K5lCFw80eVvMUpHBkzYzicSvq13ZUogCm0uxm4Oq6orjY8MmNhshakkL4wUqIAp9BM5ToA2j5kXEplDUzFxarkl+I78WVlPDBDfPDaEGNJ5UOaLdfqyJF70XUr0OS+ivctajFPbSVmTf3lqPrrV9HsmpBVIskJ/cZxRHw9rVE3JSlq7Q1S8AMgumBHWbx6fF3bUFzETWKuEoUJqdaRtJwX2C8VvTWkPOTU5IjGJ+VxMrje15ZW6Cddmrf+O7acIYawUjib8ldbVyP6kdYg/E/tRSqjTTjd8ZopUnSdXEZylaDMyIGEmY09xCnhETC+V4Lk4FuDPkBKAPuHelsoN85YSSOqJAgK0rHwAItBVx31nIni67eyj/H7mpE8dHd+P3slFFVWnhz6mLZ2lSYiJ1HjYBoWo18cHmHc94wbJTdqkpgo/NODS3qotwGGSSLGOKJMGZ0foqaix6qOTmvq+YlJBWg4ccoo2NQYpQ8Fnvwds8U1ugG/EnJ/ygSsErb2ow+mRk0wvCwAobKDsKPaCKAqx9rkBV1ZHWDeSs3GhVyByIFhQDBoGa3Vi/6LFZ0bkJmbXmbpJFnYbFWqW2Mgck="
        file_glob: true
        file: dist/*
        name: pip-download $GIT_TAG
        target_commitish: master
        on:
          branch: master
    - stage: Deploy to PyPI release
      env: TOXENV=build
      deploy:
        distributions: skip
        skip_cleanup: true
        provider: pypi
        user: "__token__"
        password:
          secure: "LccoaDgFbLlkn3uTmBDygozz1jIINoKBp4H4HZJ+uLG+JjO9Kwdi125ZepDawk52Dy2o4dMHsv18oxroOJqyDnJGWX4mmicZCYGjwYIPuvSKtjNUDOBkcSaCcxkBCsVco703FSfw/0ze5eGhf+KdGv0cu1Meyq+C+lEM2zv36/FdwzJ7h60I/kyR7kHBrD5+Nh39WFPVCjfH4tdfc55ZqKcBwSX1/2Mwlu623/cq344dQLcuPnp7SLipXIw9XkllscFeUc70cybPq8tS4ZcTR9SksWkCrvHPkNcXVGi/U55QNprRHDBfOuu6hR+xpzm92kO0EXkiljiaC2pnrMQ6dC0gdC9xj4AEYpu3oUG2H1/H/wfbUb7f2Ou/bBApfUZBPsqPqwZFirReDXh7mOzyqv0JQs+dFsCwxzXnAZKiHDPoi+KpbY+Q+8kMXqipHteF78uH219oyuYMwLYcY//QiDa758/iEjYhynWL8gZyHG5eHlnB519nbn+4iubcR30VHD43KYfOH032Qwjk3/gmpt2fHekXjWey2797K439QunAMDyBN0xKpUmdMd7r4gqu5pQwrFfGiPYTR11fD1k2a0VX4MLq481ZA3tXwyCUEPgMnjHK/qToxFs4ByqHDnibw/fJelZIFnQPoYQYFT0ImPcYBxjTtCSotgoPC15+GX4="
        on:
          tags: true
    - stage: Check version
      language: bash
      install:
        - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
        - cd $TRAVIS_REPO_SLUG
        - git checkout -qf $TRAVIS_PULL_REQUEST_BRANCH
      script: "! git diff --exit-code --quiet origin/master version.txt"

install:
  - pip install tox

script: tox

stages:
  - name: Check version
    if: branch = master AND type = pull_request
  - name: Test
  - name: Create GitHub release
    if: branch = master AND type != pull_request
  - name: Deploy to PyPI release
    if: tag IS present
